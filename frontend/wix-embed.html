<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRDD Risk Assessment Tool</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
        }
        #hrdd-app {
            min-height: 600px;
            width: 100%;
        }
        .error-container {
            background-color: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 24px;
            border-radius: 12px;
            margin: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .loading-container {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            background: white;
            border-radius: 12px;
            margin: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .component-loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .retry-button {
            padding: 12px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            margin: 8px;
        }
        .retry-button:hover {
            background-color: #2563eb;
        }
        .retry-button.danger {
            background-color: #dc2626;
        }
        .retry-button.danger:hover {
            background-color: #b91c1c;
        }
        .retry-button.secondary {
            background-color: #6b7280;
        }
        .retry-button.secondary:hover {
            background-color: #4b5563;
        }
        /* Enhanced responsive design */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            .loading-container, .error-container {
                margin: 10px;
                padding: 20px;
            }
            .retry-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        /* Accessibility improvements */
        .retry-button:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="hrdd-app">
        <div class="loading-container">
            <div class="component-loading"></div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Initializing HRDD Risk Assessment Tool</div>
            <div style="font-size: 14px; color: #6b7280;">Loading modular components and country data...</div>
            <div style="font-size: 12px; margin-top: 16px; opacity: 0.8;">
                This may take a few moments on first load
            </div>
        </div>
    </div>

    <script type="module">
        // Enhanced error handling and retry logic
        let initializationAttempts = 0;
        const maxAttempts = 3;
        const retryDelay = 2000;

        // Global error handler with better user feedback
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showError('Component Loading Error', 
                'Failed to load application components. This may be due to network connectivity issues.',
                true, // show retry
                'Check that the Railway server is running and components are accessible.');
        });

        // Enhanced error display function
        function showError(title, message, showRetry = true, details = '') {
            document.getElementById('hrdd-app').innerHTML = `
                <div class="error-container">
                    <div style="font-size: 24px; margin-bottom: 12px;">⚠️</div>
                    <div style="font-weight: 600; font-size: 18px; margin-bottom: 12px;">${title}</div>
                    <div style="margin-bottom: 16px;">${message}</div>
                    ${details ? `<div style="font-size: 12px; opacity: 0.8; margin-bottom: 16px;">${details}</div>` : ''}
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
                        ${showRetry ? `
                            <button class="retry-button danger" onclick="retryInitialization()">
                                Retry Connection
                            </button>
                            <button class="retry-button secondary" onclick="loadOfflineMode()">
                                Load Demo Mode
                            </button>
                        ` : ''}
                        <button class="retry-button" onclick="location.reload()">
                            Refresh Page
                        </button>
                    </div>
                    <div style="font-size: 11px; margin-top: 16px; opacity: 0.6;">
                        If problems persist, please contact support or try again later.
                    </div>
                </div>
            `;
        }

        // Enhanced loading display function
        function showLoading(message = 'Loading...', details = '') {
            document.getElementById('hrdd-app').innerHTML = `
                <div class="loading-container">
                    <div class="component-loading"></div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${message}</div>
                    ${details ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">${details}</div>` : ''}
                    <div style="font-size: 12px; opacity: 0.8;">
                        Attempt ${initializationAttempts + 1} of ${maxAttempts}
                    </div>
                </div>
            `;
        }

        // Component availability checker
        async function checkComponentAvailability() {
            const components = [
                'DataService.js',
                'RiskEngine.js', 
                'UIComponents.js',
                'AppController.js'
            ];

            const baseURL = 'https://riskmap2-production.up.railway.app/components';
            const results = {};

            for (const component of components) {
                try {
                    const response = await fetch(`${baseURL}/${component}`, { method: 'HEAD' });
                    results[component] = response.ok;
                } catch (error) {
                    results[component] = false;
                }
            }

            return results;
        }

        // Enhanced initialization function with comprehensive error handling
        async function initializeApp() {
            try {
                initializationAttempts++;
                
                showLoading(
                    'Initializing HRDD Risk Assessment Tool', 
                    'Checking component availability and loading modules...'
                );

                // Check if components are available
                const componentStatus = await checkComponentAvailability();
                const unavailableComponents = Object.entries(componentStatus)
                    .filter(([name, available]) => !available)
                    .map(([name]) => name);

                if (unavailableComponents.length > 0) {
                    throw new Error(`Components not available: ${unavailableComponents.join(', ')}`);
                }

                // Import components dynamically with timeout
                const componentPromises = [
                    import('https://riskmap2-production.up.railway.app/components/AppController.js')
                ];

                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Component loading timeout')), 15000)
                );

                const [{ AppController }] = await Promise.race([
                    Promise.all(componentPromises),
                    timeoutPromise
                ]);

                showLoading(
                    'Components Loaded Successfully', 
                    'Initializing application and connecting to API...'
                );

                // Create app controller instance with enhanced error handling
                const appController = new AppController();
                
                // Make it globally accessible for debugging and retry functions
                window.hrddApp = appController;
                
                // Add cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    if (window.hrddApp && typeof window.hrddApp.destroy === 'function') {
                        window.hrddApp.destroy();
                    }
                });

                // Initialize with enhanced error catching
                await appController.initialize('hrdd-app');
                
                console.log('✅ HRDD Risk Assessment Tool initialized successfully');
                
                // Reset attempt counter on success
                initializationAttempts = 0;
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                
                // Determine error type and show appropriate message
                let errorTitle = 'Initialization Error';
                let errorMessage = error.message;
                let showRetry = true;
                let details = '';

                if (error.message.includes('Components not available')) {
                    errorTitle = 'Server Connection Error';
                    errorMessage = 'Unable to load application components from the server.';
                    details = 'Please check that the Railway server is running and accessible.';
                } else if (error.message.includes('timeout')) {
                    errorTitle = 'Loading Timeout';
                    errorMessage = 'Components are taking too long to load.';
                    details = 'This may be due to slow network connectivity. Please try again.';
                } else if (error.message.includes('Failed to load countries')) {
                    errorTitle = 'Data Loading Error';
                    errorMessage = 'Unable to connect to the country data API.';
                    details = 'The application loaded but cannot retrieve country information.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorTitle = 'Network Error';
                    errorMessage = 'Unable to connect to the application server.';
                    details = 'Please check your internet connection and try again.';
                }

                // Show retry option only if we haven't exceeded max attempts
                if (initializationAttempts >= maxAttempts) {
                    showRetry = false;
                    errorMessage += ` Maximum retry attempts (${maxAttempts}) exceeded.`;
                }

                showError(errorTitle, errorMessage, showRetry, details);
            }
        }

        // Retry initialization function
        window.retryInitialization = async function() {
            if (initializationAttempts >= maxAttempts) {
                showError(
                    'Maximum Retries Exceeded',
                    'Unable to initialize the application after multiple attempts.',
                    false,
                    'Please refresh the page or contact support if the problem persists.'
                );
                return;
            }

            // Wait before retrying
            showLoading('Retrying Connection...', 'Please wait while we attempt to reconnect...');
            await new Promise(resolve => setTimeout(resolve, retryDelay));
            
            initializeApp();
        };

        // Load offline/demo mode
        window.loadOfflineMode = function() {
            try {
                if (window.hrddApp && typeof window.hrddApp.loadDemoData === 'function') {
                    window.hrddApp.loadDemoData();
                } else {
                    // Create minimal demo if app controller isn't available
                    document.getElementById('hrdd-app').innerHTML = `
                        <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                            <div style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 16px;">📊</div>
                                <h1 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px;">
                                    HRDD Risk Assessment Tool
                                </h1>
                                <div style="background-color: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <strong>Demo Mode</strong><br>
                                    The full application is temporarily unavailable. Please try again later or contact support.
                                </div>
                                <button class="retry-button" onclick="location.reload()">
                                    Try Again
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load demo mode:', error);
                showError(
                    'Demo Mode Error', 
                    'Unable to load demo mode. Please refresh the page.',
                    false
                );
            }
        };

        // Add resize handler for responsive design
        window.addEventListener('resize', () => {
            if (window.hrddApp && typeof window.hrddApp.updateUI === 'function') {
                setTimeout(() => window.hrddApp.updateUI(), 100);
            }
        });

        // Add visibility change handler to pause/resume when tab changes
        document.addEventListener('visibilitychange', () => {
            if (window.hrddApp) {
                if (document.hidden) {
                    // Page is hidden, pause auto-save
                    if (window.hrddApp.autoSaveInterval) {
                        clearInterval(window.hrddApp.autoSaveInterval);
                    }
                } else {
                    // Page is visible, resume auto-save
                    if (typeof window.hrddApp.startAutoSave === 'function') {
                        window.hrddApp.startAutoSave();
                    }
                }
            }
        });

        // Keyboard shortcuts for power users
        document.addEventListener('keydown', (event) => {
            if (window.hrddApp && event.ctrlKey) {
                switch (event.key) {
                    case 's':
                        event.preventDefault();
                        if (typeof window.hrddApp.saveState === 'function') {
                            window.hrddApp.saveState();
                            console.log('💾 Manual save triggered');
                        }
                        break;
                    case 'e':
                        event.preventDefault();
                        if (typeof window.hrddApp.exportConfiguration === 'function') {
                            window.hrddApp.exportConfiguration();
                        }
                        break;
                    case 'r':
                        event.preventDefault();
                        if (typeof window.hrddApp.setState === 'function') {
                            window.hrddApp.setState({
                                weights: window.hrddApp.riskEngine?.defaultWeights || [20, 20, 5, 10, 10],
                                selectedCountries: ['USA', 'CHN', 'DEU'],
                                countryVolumes: { USA: 10, CHN: 15, DEU: 8 }
                            });
                            console.log('🔄 Configuration reset');
                        }
                        break;
                }
            }
        });

        // Performance monitoring
        const performanceObserver = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            entries.forEach((entry) => {
                if (entry.entryType === 'navigation') {
                    console.log(`📊 Page load time: ${entry.loadEventEnd - entry.loadEventStart}ms`);
                } else if (entry.entryType === 'resource' && entry.name.includes('components/')) {
                    console.log(`📦 Component load time: ${entry.name} - ${entry.duration}ms`);
                }
            });
        });
        
        try {
            performanceObserver.observe({ entryTypes: ['navigation', 'resource'] });
        } catch (e) {
            // Performance Observer not supported, continue without it
        }

        // Start the application
        console.log('🚀 Starting HRDD Risk Assessment Tool initialization...');
        initializeApp();
        
    </script>
</body>
</html>